---
title: "glm_function"
output: html_document
date: "2025-04-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(Metrics)

# -----------------------------
# Data generation function 
# -----------------------------
generate_data <- function(n, hetero_effect, nonlinear_prognostic) {
  x1 <- rnorm(n)
  x2 <- rnorm(n)
  x3 <- rnorm(n)
  x4 <- sample(0:1, n, replace = TRUE)
  x5 <- sample(1:3, n, replace = TRUE)
  
  tau <- if (!hetero_effect) {
    rep(3, n)
  } else {
    1 + 2 * x2 * x4
  }
  
  g <- c(`1` = 2, `2` = -1, `3` = -4)
  if (!nonlinear_prognostic) {
    mu <- 1 + g[as.character(x5)] + x1 * x3
  } else {
    mu <- -6 + g[as.character(x5)] + 6 * abs(x3 - 1)
  }
  
  s <- sd(mu)
  pi <- 0.8 * pnorm((3 * mu) / s - 0.5 * x1) + 0.05 + runif(n, 0, 0.1)
  
  Z <- rbinom(n, 1, pi)
  Y <- mu + tau * Z + rnorm(n)
  
  data.frame(x1, x2, x3, x4, x5, tau, mu, pi, Z, Y)
}

# -----------------------------
# Function to run GLM simulation
# -----------------------------
run_glm_simulation_summary <- function(hetero_effect = TRUE,
                                       n = 250,
                                       nonlinear_prognostic = TRUE,
                                       num_rep = 1) {
  
  results_list <- list()
  
  for (i in 1:num_rep) {
    set.seed(123 + i)
    data <- generate_data(n = n, hetero_effect = hetero_effect, nonlinear_prognostic = nonlinear_prognostic)
    
    
    glm_fit <- glm(Y ~ Z * (x1 + x2 + x3 + factor(x4) + factor(x5)), data = data)
    print(summary(glm_fit))
    
    # Predicted outcome with and without treatment
    data1 <- data
    data1$Z <- 1
    data0 <- data
    data0$Z <- 0
    
    pred1 <- predict(glm_fit, newdata = data1)
    pred0 <- predict(glm_fit, newdata = data0)
    
    tauhat <- pred1 - pred0  # Estimated tauhat (treatment effect)
    
    
    cate_rmse <- rmse(data$tau, tauhat)
    
    # Approximate uncertainty by standard error (not very accurate), use as a comparative metric with other model
    se <- summary(glm_fit)$coefficients["Z", "Std. Error"]
    tau_lower <- tauhat - 1.96 * se
    tau_upper <- tauhat + 1.96 * se
    cate_cover <- mean(data$tau >= tau_lower & data$tau <= tau_upper)
    cate_len <- mean(tau_upper - tau_lower)
    
    
    ate_true <- mean(data$tau)
    ate_estimate <- mean(tauhat)
    ate_rmse <- sqrt((ate_estimate - ate_true)^2)
    
    ate_lower <- mean(tauhat) - 1.96 * se
    ate_upper <- mean(tauhat) + 1.96 * se
    ate_cover <- as.numeric(ate_true >= ate_lower & ate_true <= ate_upper)
    ate_len <- ate_upper - ate_lower
    
    # ATE len = CATE len (2 * 1.96 * se)
    results_list[[i]] <- tibble(
      rep = i,
      ate_rmse = ate_rmse,
      ate_cover = ate_cover,
      ate_len = ate_len,
      cate_rmse = cate_rmse,
      cate_cover = cate_cover,
      cate_len = cate_len
    )
  }
  
  results_df <- bind_rows(results_list)
  
  summary_results <- results_df %>%
    summarise(
      ate_rmse = mean(ate_rmse, na.rm = TRUE),
      ate_cover = mean(ate_cover, na.rm = TRUE),
      ate_len = mean(ate_len, na.rm = TRUE),
      cate_rmse = mean(cate_rmse, na.rm = TRUE),
      cate_cover = mean(cate_cover, na.rm = TRUE),
      cate_len = mean(cate_len, na.rm = TRUE)
    )
  
  print(summary_results)
}

```

```{r}

start_time <- Sys.time()

run_glm_simulation_summary(hetero_effect = TRUE, n = 250, nonlinear_prognostic = FALSE, num_rep = 50)

end_time <- Sys.time()
time_taken <- end_time - start_time
print(time_taken)

```