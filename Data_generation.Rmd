---
title: "Data_Generating"
output: html_document
date: "2025-04-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

## Data Generation

```{r}
# Load required libraries
library(dplyr)
library(purrr)

# Function to generate data
generate_data <- function(n, hetero_effect, nonlinear_prognostic) {
  x1 <- rnorm(n)
  x2 <- rnorm(n)
  x3 <- rnorm(n)
  x4 <- sample(0:1, n, replace = TRUE)
  x5 <- sample(1:3, n, replace = TRUE)

  # Treatment effect
  tau <- if (!hetero_effect) {
    rep(3, n)
  } else {
    1 + 2 * x2 * x4
  }

  # Prognostic function
  g <- c(`1` = 2, `2` = -1, `3` = -4, `try` = 12)
  if (!nonlinear_prognostic) {
    mu <- 1 + g[as.character(x5)] + x1 * x3
  } else {
    mu <- -6 + g[as.character(x5)] + 6 * abs(x3 - 1)
  }

  # Propensity score
  s <- sd(mu)
  u <- runif(n, 0, 1)
  pi <- 0.8 * pnorm((3 * mu) / s - 0.5 * x1) + 0.05 + u/10

  # Treatment assignment
  Z <- rbinom(n, 1, pi)

  # Outcome variable
  Y <- mu + tau * Z + rnorm(n)

  # Combine into dataframe
  data.frame(x1, x2, x3, x4, x5, tau, mu, pi, Z, Y)
}

# Scenarios
data_conditions <- expand.grid(
  hetero_effect = c(FALSE, TRUE),
  nonlinear_prognostic = c(FALSE, TRUE),
  n = c(250, 500)
)

# Generate all datasets
all_datasets <- pmap(
  data_conditions,
  ~ generate_data(..3, ..1, ..2)
)

names(all_datasets) <- with(data_conditions, paste0(
  ifelse(hetero_effect, "Heterogeneous", "Homogeneous"), "_",
  ifelse(nonlinear_prognostic, "Nonlinear", "Linear"),
  "_n", n
))

# Example to access a dataset
head(all_datasets$Heterogeneous_Nonlinear_n250)
```
